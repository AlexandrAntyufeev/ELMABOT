import os
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, InputFile
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

BACK = "‚¨ÖÔ∏è –ù–∞–∑–∞–¥"

USER_STATE = {}

# –û—Ç–≤–µ—Ç—ã —Å –∫—Ä–∞—Ç–∫–æ–π —Å–ø—Ä–∞–≤–∫–æ–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
RESPONSES = {
    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    "üìë –≠–î–û": {
        "text": "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
        "image": "edo_image.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä—ã": {
        "text": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –¥–æ–≥–æ–≤–æ—Ä–æ–º:",
        "image": "dogovor_image.png"
    },
    "üìë –ö–≠–î–û": {
        "text": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –ö–≠–î–û:",
        "image": "kedo_image.png"
    },
    "üè¢ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã": {
        "text": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º–∏:",
        "image": "kontargent_image.png"
    },
    "üë§ –ü–æ–¥–ø–∏—Å–∞–Ω—Ç—ã": {
        "text": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–æ–º:",
        "image": "podpisant_image.png"
    },

    # –≠–î–û
    "üìë –≠–î–û: üìù –°–ª—É–∂–µ–±–Ω—ã–µ –∑–∞–ø–∏—Å–∫–∏": {
        "text": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å —Å–ª—É–∂–µ–±–Ω—ã–º–∏ –∑–∞–ø–∏—Å–∫–∞–º–∏:",
        "image": "service_note.png"
    },
    "üìë –≠–î–û: üì§ –ò—Å—Ö–æ–¥—è—â–∏–µ –ø–∏—Å—å–º–∞": {
        "text": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –∏—Å—Ö–æ–¥—è—â–∏–º–∏ –ø–∏—Å—å–º–∞–º–∏:",
        "image": "outgoing_mail.png"
    },
    "üìë –≠–î–û: üì• –í—Ö–æ–¥—è—â–∏–µ –ø–∏—Å—å–º–∞": {
        "text": "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –≤—Ö–æ–¥—è—â–∏–º–∏ –ø–∏—Å—å–º–∞–º–∏:",
        "image": "incoming_mail.png"
    },

    # –î–æ–≥–æ–≤–æ—Ä—ã
    "üìÑ –î–æ–≥–æ–≤–æ—Ä—ã: üìÑ –î–æ–≥–æ–≤–æ—Ä": {
        "text": "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É +–î–æ–≥–æ–≤–æ—Ä. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (*), –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ.",
        "image": "dogovor_create.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä—ã: üìë –î–°": {
        "text": "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞ —Å —É—á–µ—Ç–æ–º –î–° –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ.",
        "image": "ds_create.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä—ã: üìú –ü–°–¶": {
        "text": "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –ü–°–¶ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ.",
        "image": "psc_create.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä—ã: üìã –°–æ–≥–ª–∞—à–µ–Ω–∏—è": {
        "text": "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É +–°–æ–≥–ª–∞—à–µ–Ω–∏–µ, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ.",
        "image": "agreement_create.png"
    },

    # –ö–≠–î–û
    "üìë –ö–≠–î–û: üíª –£–¥–∞–ª—ë–Ω–∫–∞": {
        "text": "–î–µ–π—Å—Ç–≤–∏—è —Å —É–¥–∞–ª—ë–Ω–∫–æ–π –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.",
        "image": "remote_work.png"
    },
    "üìë –ö–≠–î–û: üìù –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–¥–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª–∞": {
        "text": "–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–¥–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–ª–∞.",
        "image": "staff_request.png"
    },

    # –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã
    "üè¢ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã: üè¢ –°–æ–∑–¥–∞–Ω–∏–µ": {
        "text": "–ù–∞–∂–º–∏—Ç–µ +–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç. –£–∫–∞–∂–∏—Ç–µ –ò–ù–ù –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ.",
        "image": "contractor_create.png"
    },
    "üè¢ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã: ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ": {
        "text": "–ù–∞—á–Ω–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º.",
        "image": "contractor_approval.png"
    },

    # –ü–æ–¥–ø–∏—Å–∞–Ω—Ç—ã
    "üë§ –ü–æ–¥–ø–∏—Å–∞–Ω—Ç—ã: –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ": {
        "text": "–ü–æ–¥–ø–∏—Å–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º.",
        "image": "sign_document.png"
    },
    "üë§ –ü–æ–¥–ø–∏—Å–∞–Ω—Ç—ã: –ü–æ–¥–ø–∏—Å–∞–Ω–æ —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω": {
        "text": "–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∞–Ω –æ–±–µ–∏–º–∏ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏.",
        "image": "signed_document.png"
    },
    
    # –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞
    "üìÑ –î–æ–≥–æ–≤–æ—Ä: –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞": {
        "text": "–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –∫–∞—Ä—Ç–æ—á–∫—É –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É, –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º.",
        "image": "kartochka.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä: –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞: –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é": {
        "text": "–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ‚Äì –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç—É –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è.",
        "image": "registration_request.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä: –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ": {
        "text": "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ ‚Äì –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –Ω–µ—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è.",
        "image": "partial_edit.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä: –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–µ—Ä–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ": {
        "text": "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–µ—Ä–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ ‚Äì –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –¥–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–µ—Ä–≤—ë—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –≤–µ—Ä–Ω—ë—Ç –¥–æ–≥–æ–≤–æ—Ä –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏.",
        "image": "edit_and_interrupt_approval.png"
    },

    # –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ
    "üìÑ –î–æ–≥–æ–≤–æ—Ä: ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ": {
        "text": "–î–ª—è —Ç–∏–ø–æ–≤–æ–π —Ñ–æ—Ä–º—ã –¥–æ–≥–æ–≤–æ—Ä–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —à–∞–±–ª–æ–Ω –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç —à–∞–±–ª–æ–Ω –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º–∏ –∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ –≤ —Å–∏—Å—Ç–µ–º–µ...",
        "image": "agreement_approval.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä: üìù –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ": {
        "text": "–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º –Ω–µ—Ç–∏–ø–æ–≤–æ–π —Ñ–æ—Ä–º—ã –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —à–∞–±–ª–æ–Ω –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –¥–æ–≥–æ–≤–æ—Ä–∞...",
        "image": "agreement_review.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä: –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ": {
        "text": "–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª—É—á–µ–Ω—ã –≤—Å–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –æ—Ç –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª–æ–≤ (—É—á–∏—Ç—ã–≤–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏), –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞...",
        "image": "sign_order.png"
    },
    "üìÑ –î–æ–≥–æ–≤–æ—Ä: –ü–æ–¥–ø–∏—Å–∞–Ω–æ —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω": {
        "text": "–ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞, —Ç–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä –ø–æ–ª—É—á–∏—Ç –∑–∞–¥–∞—á—É –ø–æ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—é —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω.",
        "image": "signed_contract.png"
    }
}

# –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
MAIN_MENU = [
    "üìë –≠–î–û", "üìÑ –î–æ–≥–æ–≤–æ—Ä—ã", "üìë –ö–≠–î–û", "üè¢ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã", "üë§ –ü–æ–¥–ø–∏—Å–∞–Ω—Ç—ã"
]

# –ù–∞–≤–∏–≥–∞—Ü–∏—è
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    USER_STATE[update.effective_user.id] = "MAIN"
    keyboard = [[KeyboardButton(item)] for item in MAIN_MENU]
    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text

    if text == BACK:
        USER_STATE[user_id] = "MAIN"
        keyboard = [[KeyboardButton(item)] for item in MAIN_MENU]
        await update.message.reply_text("–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))
        return

    current_state = USER_STATE.get(user_id, "MAIN")

    # –ü–µ—Ä–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤–≥–ª—É–±—å
    if current_state == "MAIN" and any(k.startswith(text) for k in RESPONSES):
        USER_STATE[user_id] = text
        options = [k.split(":")[1].strip() for k in RESPONSES if k.startswith(text)]
        keyboard = [[KeyboardButton(option)] for option in options] + [[KeyboardButton(BACK)]]
        await update.message.reply_text(f"–†–∞–∑–¥–µ–ª: {text}. –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))
        return

    # –û—Ç–≤–µ—Ç –ø–æ —Å–ø—Ä–∞–≤–∫–µ
    full_key = f"{current_state}: {text}"
    if full_key in RESPONSES:
        resp = RESPONSES[full_key]
        await update.message.reply_text(resp["text"])
        try:
            with open(f"images/{resp['image']}", "rb") as img:
                await update.message.reply_photo(photo=InputFile(img))
        except Exception:
            await update.message.reply_text("‚ö†Ô∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∞.")
        return

    await update.message.reply_text("–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –ø–æ–Ω—è–ª. –ù–∞–∂–º–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞.")

if __name__ == '__main__':
    app = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()
